# J-Link PC Sampling 기반 SSD 펌웨어 커버리지 퍼징 시스템

## 프로젝트 개요

**프로젝트명**: 비침습적 PC Sampling 기반 SSD 펌웨어 퍼징 시스템

**목표**: CPU를 최소한으로 멈추면서 커버리지 기반 퍼징을 수행하여, NVMe 타임아웃 없이 SSD 펌웨어의 취약점을 탐지

---

## 1. 시스템 Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              HOST PC                                         │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                         PC Sampling Fuzzer                           │   │
│  │                                                                      │   │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐     │   │
│  │   │   Mutator   │───▶│   Corpus    │◀───│  Coverage Evaluator │     │   │
│  │   │ (입력 변형)  │    │ (유효 입력) │    │   (새 경로 판단)     │     │   │
│  │   └─────────────┘    └─────────────┘    └─────────────────────┘     │   │
│  │          │                                         ▲                 │   │
│  │          ▼                                         │                 │   │
│  │   ┌─────────────┐                          ┌──────┴──────┐          │   │
│  │   │ NVMe Sender │                          │  PC Sample  │          │   │
│  │   │ (명령 전송)  │                          │  Collector  │          │   │
│  │   └──────┬──────┘                          └──────┬──────┘          │   │
│  │          │                                        │                  │   │
│  └──────────┼────────────────────────────────────────┼──────────────────┘   │
│             │                                        │                       │
│             │ NVMe CLI                               │ pylink                │
│             │                                        │                       │
└─────────────┼────────────────────────────────────────┼───────────────────────┘
              │                                        │
              │ PCIe/NVMe                              │ USB
              │                                        │
              │                                 ┌──────┴──────┐
              │                                 │   J-Link    │
              │                                 │     V9      │
              │                                 └──────┬──────┘
              │                                        │ JTAG
              │                                        │
              ▼                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              SSD Controller                                  │
│                             (ARM Cortex-R8)                                  │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         Firmware                                     │   │
│   │                                                                      │   │
│   │    NVMe Command    ┌──────────────────────────────────────────┐     │   │
│   │    ───────────────▶│           Command Handler                │     │   │
│   │                    │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐        │     │   │
│   │                    │  │Read │ │Write│ │ ID  │ │Vendor│ ...   │     │   │
│   │                    │  └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘        │     │   │
│   │                    │     │       │       │       │            │     │   │
│   │                    │     ▼       ▼       ▼       ▼            │     │   │
│   │    PC Sampling ◀───│  [0x1000][0x2000][0x3000][0x4000] ...   │     │   │
│   │    (J-Link)        │         코드 실행 경로                   │     │   │
│   │                    └──────────────────────────────────────────┘     │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 배경 및 필요성

### 2.1 기존 방식의 한계

```
┌─────────────────────────────────────────────────────────────────┐
│              기존 GDBFuzz (Hardware Breakpoint 방식)             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   NVMe 커맨드 전송 ──▶ 브레이크포인트 Hit ──▶ CPU 완전 정지      │
│                                │                                 │
│                                ▼                                 │
│                    ┌──────────────────────┐                     │
│                    │   CPU Halt (수백 ms)  │                     │
│                    │   - 커버리지 기록     │                     │
│                    │   - BP 재설정         │                     │
│                    └──────────────────────┘                     │
│                                │                                 │
│                                ▼                                 │
│                    ┌──────────────────────┐                     │
│                    │  NVMe 응답 지연       │                     │
│                    │  (Host Timeout!)     │                     │
│                    └──────────────────────┘                     │
│                                                                  │
│   문제점:                                                        │
│   ❌ NVMe Host Timeout (보통 500ms ~ 5s)                        │
│   ❌ Watchdog Reset 발생                                        │
│   ❌ SSD 연결 끊김                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 PC Sampling 방식의 장점

```
┌─────────────────────────────────────────────────────────────────┐
│              PC Sampling 방식 (Halt-Sample-Resume)              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   NVMe 커맨드 전송 ──▶ 펌웨어 실행 ──▶ 정상 응답                │
│                          │                                       │
│              ┌───────────┴───────────┐                          │
│              ▼           ▼           ▼                          │
│         [Sample 1]  [Sample 2]  [Sample 3] ...                  │
│         Halt(10μs)  Halt(10μs)  Halt(10μs)                      │
│         Read PC     Read PC     Read PC                         │
│         Resume      Resume      Resume                          │
│              │           │           │                          │
│              └───────────┴───────────┘                          │
│                          │                                       │
│                          ▼                                       │
│              ┌──────────────────────┐                           │
│              │  Coverage Set 구성   │                           │
│              │  {0x1234, 0x5678...} │                           │
│              └──────────────────────┘                           │
│                                                                  │
│   장점:                                                          │
│   ✅ 각 Halt가 매우 짧음 (~10μs)                                │
│   ✅ NVMe Timeout 회피 가능                                     │
│   ✅ Ghidra CFG 분석 불필요                                     │
│   ✅ 즉시 퍼징 시작 가능                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 시스템 아키텍처

### 3.1 하드웨어 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                        Hardware Setup                            │
└─────────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │   Host PC   │
                    │  (Ubuntu)   │
                    └──────┬──────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
              │ USB        │ PCIe       │
              │            │            │
              ▼            │            ▼
       ┌──────────┐        │     ┌─────────────┐
       │  J-Link  │        │     │ NVMe Device │
       │    V9    │        │     │ (/dev/nvme0)│
       └────┬─────┘        │     └──────┬──────┘
            │              │            │
            │ JTAG         │            │ PCIe
            │              │            │
            └──────────────┼────────────┘
                           │
                           ▼
                 ┌─────────────────┐
                 │      SSD        │
                 │  ┌───────────┐  │
                 │  │ Cortex-R8 │◀─┼─── JTAG (PC Sampling)
                 │  └───────────┘  │
                 │  ┌───────────┐  │
                 │  │   NAND    │  │
                 │  └───────────┘  │
                 │  ┌───────────┐  │
                 │  │   DRAM    │  │
                 │  └───────────┘  │
                 └─────────────────┘

필요 장비:
┌────────────────┬─────────────────────────────────┐
│ 장비           │ 용도                             │
├────────────────┼─────────────────────────────────┤
│ Host PC        │ 퍼저 실행, NVMe 명령 전송        │
│ J-Link V9      │ JTAG 연결, PC 레지스터 읽기      │
│ JTAG 케이블    │ J-Link ↔ SSD 연결               │
│ SSD            │ 퍼징 대상                        │
│ PCIe 어댑터    │ Host ↔ SSD NVMe 연결            │
└────────────────┴─────────────────────────────────┘
```

### 3.2 소프트웨어 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                       Software Stack                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     PC Sampling Fuzzer                           │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Main Controller                         │  │
│  │  - 퍼징 루프 관리                                          │  │
│  │  - 통계 수집 및 출력                                       │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│        ┌─────────────────────┼─────────────────────┐            │
│        ▼                     ▼                     ▼            │
│  ┌───────────┐        ┌───────────┐        ┌───────────┐       │
│  │  Mutator  │        │  Sampler  │        │  NVMe     │       │
│  │           │        │           │        │  Sender   │       │
│  │ - 입력 변형│        │ - PC 수집 │        │ - 명령전송│       │
│  │ - 시드 관리│        │ - 커버리지│        │ - 에러처리│       │
│  └───────────┘        └─────┬─────┘        └─────┬─────┘       │
│                             │                     │              │
└─────────────────────────────┼─────────────────────┼──────────────┘
                              │                     │
                              ▼                     ▼
                       ┌───────────┐         ┌───────────┐
                       │  pylink   │         │ nvme-cli  │
                       │ (J-Link)  │         │ (NVMe)    │
                       └───────────┘         └───────────┘

의존성:
┌────────────────┬─────────────────────────────────┐
│ 패키지         │ 용도                             │
├────────────────┼─────────────────────────────────┤
│ pylink-square  │ J-Link Python 인터페이스        │
│ nvme-cli       │ NVMe 명령 전송                  │
│ Python 3.8+    │ 퍼저 실행 환경                  │
└────────────────┴─────────────────────────────────┘
```

---

## 4. 핵심 알고리즘

### 4.1 퍼징 메인 루프

```
┌─────────────────────────────────────────────────────────────────┐
│                      Fuzzing Main Loop                           │
└─────────────────────────────────────────────────────────────────┘

                         ┌─────────────┐
                         │    Start    │
                         └──────┬──────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   J-Link 연결         │
                    │   시드 로드           │
                    └───────────┬───────────┘
                                │
          ┌─────────────────────┴─────────────────────┐
          │                                           │
          ▼                                           │
┌─────────────────────┐                               │
│ 1. Corpus에서 선택  │                               │
│    & Mutation       │                               │
└─────────┬───────────┘                               │
          │                                           │
          ▼                                           │
┌─────────────────────┐                               │
│ 2. Sampling 시작    │◀──────────────────────────────┤
│    (백그라운드)      │                               │
└─────────┬───────────┘                               │
          │                                           │
          ▼                                           │
┌─────────────────────┐                               │
│ 3. NVMe 커맨드 전송 │                               │
│    (Read/Write/VS)  │                               │
└─────────┬───────────┘                               │
          │                                           │
          ▼                                           │
┌─────────────────────┐                               │
│ 4. Sampling 종료    │                               │
│    PC Set 수집      │                               │
└─────────┬───────────┘                               │
          │                                           │
          ▼                                           │
┌─────────────────────┐                               │
│ 5. Coverage 평가    │                               │
│    새 PC 발견?      │                               │
└─────────┬───────────┘                               │
          │                                           │
          ├─── Yes ──▶ ┌─────────────────┐           │
          │            │ Corpus에 저장   │           │
          │            │ (Interesting!)  │           │
          │            └────────┬────────┘           │
          │                     │                     │
          ├─── No ───┐         │                     │
          │          │         │                     │
          ▼          ▼         ▼                     │
┌─────────────────────────────────────────┐         │
│ 6. 타임아웃 체크                         │         │
│    - 총 실행 시간 초과?                  │         │
└─────────────────────┬───────────────────┘         │
                      │                              │
                      ├─── No ───────────────────────┘
                      │
                      ▼
               ┌─────────────┐
               │    종료     │
               │  통계 출력  │
               └─────────────┘
```

### 4.2 PC Sampling 상세

```
┌─────────────────────────────────────────────────────────────────┐
│                    PC Sampling Detail                            │
└─────────────────────────────────────────────────────────────────┘

Timeline:
═══════════════════════════════════════════════════════════════════

  NVMe 커맨드 시작                               NVMe 커맨드 완료
        │                                              │
        ▼                                              ▼
────────┼──────────────────────────────────────────────┼──────────
        │                                              │
        │  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐       │
        │  │S1│  │S2│  │S3│  │S4│  │S5│  │S6│ ...   │
        │  └┬─┘  └┬─┘  └┬─┘  └┬─┘  └┬─┘  └┬─┘       │
        │   │     │     │     │     │     │          │
────────┴───┴─────┴─────┴─────┴─────┴─────┴──────────┴──────────
            │     │     │     │     │     │
            ▼     ▼     ▼     ▼     ▼     ▼
         0x1234 0x1238 0x5678 0x5680 0x1234 0x9ABC
            │     │     │     │     │     │
            └─────┴─────┴─────┴─────┴─────┘
                          │
                          ▼
              ┌─────────────────────┐
              │ Current Trace Set   │
              │ {0x1234, 0x1238,    │
              │  0x5678, 0x5680,    │
              │  0x9ABC}            │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │  Compare with       │
              │  Global Coverage    │
              │  {0x1234, 0x1238,   │
              │   0x2000, 0x3000}   │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │  New PCs Found!     │
              │  {0x5678, 0x5680,   │
              │   0x9ABC}           │
              │                     │
              │  → Interesting!     │
              │  → Save to Corpus   │
              └─────────────────────┘


Single Sample Operation:
────────────────────────

    Running ──▶ Halt ──▶ Read R15 ──▶ Resume ──▶ Running
                 │         │
                 │         └── PC = 0x5678
                 │
                 └── ~10μs (매우 짧음)

    총 샘플링 시간: 500 샘플 × 100μs 간격 = ~50ms
    (NVMe 타임아웃 5000ms 대비 충분히 짧음)
```

### 4.3 Coverage 평가

```
┌─────────────────────────────────────────────────────────────────┐
│                   Coverage Evaluation                            │
└─────────────────────────────────────────────────────────────────┘

Global Coverage (전체 세션):
┌─────────────────────────────────────────────────────────────────┐
│  {0x1000, 0x1004, 0x1008, 0x2000, 0x2100, 0x3000, ...}         │
│                                                                  │
│  = 지금까지 발견한 모든 unique PC 주소                          │
│  = 펌웨어에서 실행된 코드 위치의 집합                           │
└─────────────────────────────────────────────────────────────────┘

                              │
                              │ 새 입력 실행 후
                              ▼

Current Trace (이번 실행):
┌─────────────────────────────────────────────────────────────────┐
│  {0x1000, 0x1004, 0x5000, 0x5004}                               │
│                                                                  │
│  = 이번 입력으로 실행된 PC 주소들                               │
└─────────────────────────────────────────────────────────────────┘

                              │
                              │ 비교
                              ▼

┌─────────────────────────────────────────────────────────────────┐
│  New PCs = Current - Global                                      │
│         = {0x5000, 0x5004}                                       │
│                                                                  │
│  if len(New PCs) > 0:                                           │
│      → "Interesting!" (새 코드 경로 발견)                        │
│      → Corpus에 입력 저장                                        │
│      → Global Coverage 업데이트                                  │
│  else:                                                           │
│      → "Boring" (새 발견 없음)                                   │
│      → 입력 버림                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. NVMe 커맨드 지원

### 5.1 지원 커맨드 목록

```
┌─────────────────────────────────────────────────────────────────┐
│                    Supported NVMe Commands                       │
└─────────────────────────────────────────────────────────────────┘

Admin Commands (관리 명령):
┌──────────────┬────────┬─────────────────────────────────────────┐
│ 이름         │ Opcode │ 설명                                    │
├──────────────┼────────┼─────────────────────────────────────────┤
│ Identify     │ 0x06   │ 장치/네임스페이스 정보 조회              │
│ Get Log Page │ 0x02   │ 로그 페이지 조회                        │
│ Set Features │ 0x09   │ 기능 설정                               │
│ Get Features │ 0x0A   │ 기능 조회                               │
│ Vendor Spec  │ 0xC0+  │ 벤더 고유 명령 (퍼징 주요 대상)         │
└──────────────┴────────┴─────────────────────────────────────────┘

I/O Commands (데이터 명령):
┌──────────────┬────────┬─────────────────────────────────────────┐
│ 이름         │ Opcode │ 설명                                    │
├──────────────┼────────┼─────────────────────────────────────────┤
│ Read         │ 0x02   │ 데이터 읽기                             │
│ Write        │ 0x01   │ 데이터 쓰기                             │
└──────────────┴────────┴─────────────────────────────────────────┘

퍼징 대상 우선순위:
┌─────────────────────────────────────────────────────────────────┐
│  1. Vendor Specific (0xC0~0xFF)                                 │
│     → 검증이 덜 된 코드, 취약점 가능성 높음                     │
│                                                                  │
│  2. Write (0x01)                                                │
│     → 데이터 처리 로직, 버퍼 오버플로우 가능성                  │
│                                                                  │
│  3. Set Features (0x09)                                         │
│     → 설정 변경 로직                                            │
│                                                                  │
│  4. Read (0x02), Get Log Page (0x02)                           │
│     → 상대적으로 단순, 낮은 우선순위                            │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 NVMe CLI 사용

```bash
# Admin Command (admin-passthru)
nvme admin-passthru /dev/nvme0 \
    --opcode=0xC0 \
    --input-file=/tmp/fuzz_data \
    --data-len=512 \
    --timeout=5000

# I/O Command (io-passthru)
nvme io-passthru /dev/nvme0 \
    --opcode=0x01 \
    --namespace-id=1 \
    --input-file=/tmp/fuzz_data \
    --data-len=512 \
    --cdw10=0 \        # LBA 하위
    --cdw11=0 \        # LBA 상위
    --cdw12=0          # 블록 수
```

---

## 6. 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                        Data Flow                                 │
└─────────────────────────────────────────────────────────────────┘

Input Generation:
                    ┌─────────────────┐
                    │  Initial Seeds  │
                    │  - 0x00 * 64    │
                    │  - 0xFF * 64    │
                    │  - random bytes │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │    Mutation     │
                    │  - byte flip    │
                    │  - insert       │
                    │  - delete       │
                    │  - special val  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  Fuzz Input     │
                    │  (bytes)        │
                    └────────┬────────┘
                             │
                             ▼
             ┌───────────────┴───────────────┐
             │                               │
             ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │ /tmp/fuzz_input │             │  NVMe Command   │
    │ (file)          │────────────▶│  (nvme-cli)     │
    └─────────────────┘             └────────┬────────┘
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │      SSD        │
                                    │   (처리 중)     │
                                    └────────┬────────┘
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │  PC Sampling    │
                                    │  {0x1234, ...}  │
                                    └────────┬────────┘
                                             │
              ┌──────────────────────────────┴─────────┐
              │                                        │
              ▼                                        ▼
    ┌─────────────────┐                      ┌─────────────────┐
    │  Interesting    │                      │    Boring       │
    │  (새 경로 발견)  │                      │  (새 발견 없음)  │
    └────────┬────────┘                      └────────┬────────┘
             │                                        │
             ▼                                        ▼
    ┌─────────────────┐                      ┌─────────────────┐
    │  Save to Corpus │                      │     Discard     │
    │  output/corpus/ │                      │                 │
    └─────────────────┘                      └─────────────────┘
```

---

## 7. 출력 및 결과

### 7.1 출력 폴더 구조

```
output/pc_sampling_v2/
├── corpus/                    # 유의미한 입력들
│   ├── input_Write_0x1_a1b2c3d4
│   ├── input_Write_0x1_a1b2c3d4.json  (메타데이터)
│   ├── input_VendorSpecific_0xc0_e5f6g7h8
│   └── ...
│
├── crashes/                   # 크래시/타임아웃 유발 입력
│   ├── crash_Write_0x1_deadbeef
│   └── ...
│
├── stats.json                 # 통계 데이터
│   {
│     "executions": 1000,
│     "corpus_size": 45,
│     "crashes": 2,
│     "coverage_unique_pcs": 1234,
│     "command_stats": {
│       "Write": {"exec": 400, "interesting": 20},
│       "Read": {"exec": 350, "interesting": 15},
│       "VendorSpecific": {"exec": 250, "interesting": 10}
│     }
│   }
│
└── coverage.txt               # 발견된 모든 PC 주소
    0x00010000
    0x00010004
    0x00010008
    ...
```

### 7.2 실시간 출력

```
============================================================
 PC Sampling SSD Fuzzer v2 - Multi-Opcode Support
============================================================
Device: /dev/nvme0
Commands: ['Identify', 'Read', 'Write', 'VendorSpecific']
J-Link: Cortex-R8
============================================================

[Stats] exec: 100 | corpus: 12 | crashes: 0 | coverage: 456 | exec/s: 2.1
[Stats] exec: 200 | corpus: 18 | crashes: 0 | coverage: 523 | exec/s: 2.3
[Stats] exec: 300 | corpus: 21 | crashes: 1 | coverage: 567 | exec/s: 2.2
[!] Crash/Timeout with VendorSpecific!
...

============================================================
 Fuzzing Complete
============================================================
Total executions: 1,000
Corpus size: 45
Crashes: 2
Coverage (unique PCs): 1,234

Per-command stats:
  Identify: exec=100, interesting=5
  Read: exec=350, interesting=15
  Write: exec=400, interesting=20
  VendorSpecific: exec=150, interesting=5

Output: ./output/pc_sampling_v2/
============================================================
```

---

## 8. 기술적 한계 및 고려사항

### 8.1 J-Link V9 한계

```
┌─────────────────────────────────────────────────────────────────┐
│                   J-Link V9 Limitations                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┬───────────────┬───────────────┬───────────────┐
│ 기능            │ J-Link V9     │ J-Link Pro    │ J-Trace       │
├─────────────────┼───────────────┼───────────────┼───────────────┤
│ Halt-Resume     │ ⭕ 지원       │ ⭕ 지원       │ ⭕ 지원       │
│ Non-halt Read   │ ❌ 미지원     │ ❌ 미지원     │ ⭕ ETM 지원   │
│ SWO Trace       │ ❌ 미지원     │ ⭕ 지원       │ ⭕ 지원       │
│ 가격            │ ~$50          │ ~$500         │ ~$1,500       │
└─────────────────┴───────────────┴───────────────┴───────────────┘

J-Link V9로는 완전한 Non-intrusive가 불가능합니다.
→ Halt-Sample-Resume 방식으로 타협
→ Halt 시간을 최소화하여 타임아웃 회피
```

### 8.2 커버리지 정확도

```
┌─────────────────────────────────────────────────────────────────┐
│                 Coverage Accuracy Trade-offs                     │
└─────────────────────────────────────────────────────────────────┘

샘플링 기반 커버리지의 한계:

실제 실행 경로:    A → B → C → D → E → F → G
샘플링 결과:       A ─ ─ ─ C ─ ─ ─ ─ ─ F ─ ─   (B, D, E, G 누락)

                   ↑           ↑       ↑
                Sample 1   Sample 2  Sample 3

문제:
- 샘플 사이에 실행된 코드는 감지 불가
- 짧은 함수는 놓칠 확률 높음

완화 방법:
┌─────────────────────────────────────────────────────────────────┐
│ 1. 샘플링 간격 줄이기 (100μs → 50μs)                           │
│    - 장점: 정확도 향상                                          │
│    - 단점: CPU 부하 증가, 타임아웃 위험                         │
│                                                                  │
│ 2. 최대 샘플 수 늘리기 (500 → 1000)                            │
│    - 장점: 더 많은 PC 포인트 수집                               │
│    - 단점: 실행 시간 증가                                       │
│                                                                  │
│ 3. 여러 번 실행으로 보완                                        │
│    - 같은 입력을 여러 번 실행하면 누락된 PC 수집 가능           │
└─────────────────────────────────────────────────────────────────┘

결론:
PC Sampling은 "대략적인" 커버리지를 제공합니다.
정확한 Basic Block 커버리지가 아닌,
"이 입력이 새로운 코드 영역을 실행했을 가능성" 지표입니다.
그래도 블랙박스 퍼징보다 훨씬 효과적입니다.
```

### 8.3 PC 주소 안정성

```
┌─────────────────────────────────────────────────────────────────┐
│                    PC Address Stability                          │
└─────────────────────────────────────────────────────────────────┘

SSD 펌웨어 특성:
┌─────────────────────────────────────────────────────────────────┐
│ ✅ Bare-metal 환경 (OS 없음)                                    │
│ ✅ ASLR 없음 (주소 랜덤화 미적용)                               │
│ ✅ 고정 주소에 로드                                             │
│                                                                  │
│ → PC 주소는 Power Cycle 후에도 동일                             │
│ → 커버리지 데이터 재사용 가능                                   │
└─────────────────────────────────────────────────────────────────┘

예외 상황:
┌─────────────────────────────────────────────────────────────────┐
│ ⚠️ 펌웨어 업데이트 시 주소 변경 가능                            │
│ ⚠️ 멀티코어 환경에서 코어별 주소 다름                           │
│                                                                  │
│ → 펌웨어 버전별로 커버리지 데이터 분리 관리 권장                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 실행 방법

### 9.1 설치

```bash
# 1. Python 패키지 설치
pip install pylink-square

# 2. NVMe CLI 설치
sudo apt install nvme-cli

# 3. J-Link 소프트웨어 설치
# https://www.segger.com/downloads/jlink/ 에서 다운로드

# 4. 퍼저 다운로드
git clone https://github.com/RelaxWide/Real_Fuzzing.git
cd Real_Fuzzing
```

### 9.2 실행

```bash
# 기본 실행 (모든 커맨드)
python pc_sampling_fuzzer_v2.py

# 특정 커맨드만 사용
python pc_sampling_fuzzer_v2.py --commands VendorSpecific Write

# 상세 옵션
python pc_sampling_fuzzer_v2.py \
    --device Cortex-R8 \        # J-Link 타겟
    --nvme /dev/nvme0 \         # NVMe 장치
    --namespace 1 \             # 네임스페이스
    --commands Write Read \     # 사용할 커맨드
    --speed 4000 \              # JTAG 속도 (kHz)
    --runtime 3600 \            # 실행 시간 (초)
    --samples 500 \             # 실행당 최대 샘플
    --interval 100              # 샘플 간격 (μs)
```

### 9.3 결과 확인

```bash
# 통계 확인
cat output/pc_sampling_v2/stats.json | python -m json.tool

# 커버리지 확인
wc -l output/pc_sampling_v2/coverage.txt

# 크래시 확인
ls -la output/pc_sampling_v2/crashes/

# 코퍼스 확인
ls -la output/pc_sampling_v2/corpus/
```

---

## 10. 향후 개선 방향

```
┌─────────────────────────────────────────────────────────────────┐
│                    Future Improvements                           │
└─────────────────────────────────────────────────────────────────┘

단기 (1-2주):
├── 주소 범위 필터링 강화 (.text 섹션만 추적)
├── 커버리지 시각화 (히트맵)
└── 크래시 재현 도구

중기 (1-2개월):
├── 스마트 뮤테이션 (NVMe 구조 인식)
├── 멀티코어 지원
└── 커버리지 기반 입력 우선순위

장기:
├── J-Trace + ETM 지원 (완전 Non-intrusive)
├── 심볼 정보 활용 (함수 레벨 커버리지)
└── 자동 취약점 분류
```

---

## 11. 참고 자료

- NVMe Specification: https://nvmexpress.org/specifications/
- J-Link User Guide: https://www.segger.com/products/debug-probes/j-link/
- pylink Documentation: https://pylink.readthedocs.io/
- ARM Cortex-R Series: https://developer.arm.com/ip-products/processors/cortex-r

---

## 12. 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| v1.0 | 2024-01 | 초기 버전 (단일 opcode) |
| v2.0 | 2024-01 | 다중 opcode 지원, 커맨드별 통계 |

---

**작성자**: RelaxWide
**프로젝트**: https://github.com/RelaxWide/Real_Fuzzing
